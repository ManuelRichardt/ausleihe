<% pageTitle = 'Asset Model' %>
<%
  const safeModel = (typeof model !== 'undefined' && model) ? model : {};
  const manufacturerName = safeModel.manufacturer ? safeModel.manufacturer.name : '-';
  const categoryName = safeModel.category ? safeModel.category.name : '-';
  const attachments = Array.isArray(safeModel.attachments) ? safeModel.attachments : [];
  const images = attachments.filter(function (item) { return item && item.kind === 'image'; });
  const manuals = attachments.filter(function (item) { return item && item.kind === 'manual'; });
  const documents = attachments.filter(function (item) { return item && item.kind === 'document'; });
  const others = attachments.filter(function (item) { return item && item.kind === 'other'; });
  const customFieldDefinitionsList = Array.isArray(customFieldDefinitions) ? customFieldDefinitions : [];
  const customFieldData = (safeModel.specs && typeof safeModel.specs === 'object')
    ? safeModel.specs
    : {};
  const customFieldRows = customFieldDefinitionsList
    .map(function (definition) {
      let value = Object.prototype.hasOwnProperty.call(customFieldData, definition.id)
        ? customFieldData[definition.id]
        : undefined;
      if (value === undefined || value === null || value === '') {
        value = definition.defaultValue;
      }
      if (value === undefined || value === null || value === '') {
        return null;
      }
      let renderedValue = value;
      if (definition.type === 'boolean') {
        renderedValue = (value === true || String(value).toLowerCase() === 'true' || String(value) === '1')
          ? 'Ja'
          : 'Nein';
      }
      return {
        label: definition.label || definition.key,
        value: renderedValue,
      };
    })
    .filter(Boolean);
  const safeStock = (typeof stock !== 'undefined' && stock) ? stock : null;
  const safeBundleDefinition = (typeof bundleDefinition !== 'undefined' && bundleDefinition) ? bundleDefinition : null;
  const bundleItems = safeBundleDefinition && Array.isArray(safeBundleDefinition.items) ? safeBundleDefinition.items : [];
%>

<section class="admin models">
  <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="h3 mb-1"><%= safeModel.name || 'Asset Model' %></h1>
      <p class="text-muted mb-0">Hersteller: <%= manufacturerName %></p>
    </div>
    <div class="d-flex gap-2">
      <a href="/admin/asset-models" class="btn btn-outline-secondary">Zur Übersicht</a>
      <a href="/admin/asset-models/<%= safeModel.id %>/edit" class="btn btn-primary">Bearbeiten</a>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <dl class="row mb-0">
        <dt class="col-sm-3">Name</dt>
        <dd class="col-sm-9"><%= safeModel.name || '-' %></dd>
        <dt class="col-sm-3">Hersteller</dt>
        <dd class="col-sm-9"><%= manufacturerName %></dd>
        <dt class="col-sm-3">Kategorie</dt>
        <dd class="col-sm-9"><%= categoryName %></dd>
        <dt class="col-sm-3">Status</dt>
        <dd class="col-sm-9">
          <% if (safeModel.isActive) { %>
            <span class="badge text-bg-success">Aktiv</span>
          <% } else { %>
            <span class="badge text-bg-danger">Inaktiv</span>
          <% } %>
        </dd>
        <dt class="col-sm-3">Tracking-Typ</dt>
        <dd class="col-sm-9">
          <span class="badge text-bg-secondary"><%= safeModel.trackingType || 'serialized' %></span>
        </dd>
        <dt class="col-sm-3">Beschreibung</dt>
        <dd class="col-sm-9 preserve-text-format"><%= safeModel.description || '-' %></dd>
        <dt class="col-sm-3">Technische Beschreibung</dt>
        <dd class="col-sm-9 preserve-text-format"><%= safeModel.technicalDescription || '-' %></dd>
        <dt class="col-sm-3">Custom Fields</dt>
        <dd class="col-sm-9">
          <% if (customFieldRows.length) { %>
            <ul class="list-unstyled mb-0">
              <% customFieldRows.forEach(function(field) { %>
                <li><span class="fw-semibold"><%= field.label %>:</span> <%= field.value %></li>
              <% }) %>
            </ul>
          <% } else { %>
            -
          <% } %>
        </dd>
        <dt class="col-sm-3">Bild-URL</dt>
        <dd class="col-sm-9">
          <% if (safeModel.imageUrl) { %>
            <a href="<%= safeModel.imageUrl %>" target="_blank" rel="noreferrer">Bild öffnen</a>
          <% } else { %>
            -
          <% } %>
        </dd>
        <dt class="col-sm-3">Anhänge</dt>
        <dd class="col-sm-9">
          <% if (attachments.length) { %>
            <div class="d-grid gap-4">
              <div>
                <div class="fw-semibold mb-2">Bilder</div>
                <% if (images.length) { %>
                  <div class="d-grid gap-2">
                    <% images.forEach(function(file) { %>
                      <form method="post" action="/admin/asset-models/<%= safeModel.id %>/attachments/<%= file.id %>" class="border rounded p-2">
                        <input type="hidden" name="csrfToken" value="<%= csrfToken || '' %>">
                        <div class="row g-2 align-items-center">
                          <div class="col-md-3">
                            <a href="<%= file.url %>" target="_blank" rel="noreferrer">
                              <img src="<%= file.url %>" alt="Asset Model Bild" class="img-thumbnail w-100">
                            </a>
                          </div>
                          <div class="col-md-5">
                            <input type="text" name="title" class="form-control form-control-sm" value="<%= file.title || '' %>" placeholder="Titel">
                          </div>
                          <div class="col-md-2">
                            <select name="kind" class="form-select form-select-sm">
                              <option value="image" selected>image</option>
                              <option value="manual">manual</option>
                              <option value="document">document</option>
                              <option value="other">other</option>
                            </select>
                          </div>
                          <div class="col-md-2 d-flex justify-content-end gap-2">
                            <div class="form-check mt-1">
                              <input class="form-check-input" type="checkbox" name="isPrimary" value="1" <%= file.isPrimary ? 'checked' : '' %> title="Primärbild">
                            </div>
                            <button type="submit" class="btn btn-outline-primary btn-sm"><i class="bi bi-check2"></i></button>
                            <button type="submit" formaction="/admin/asset-models/<%= safeModel.id %>/attachments/<%= file.id %>/delete" formmethod="post" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash3-fill"></i></button>
                          </div>
                        </div>
                      </form>
                    <% }) %>
                  </div>
                <% } else { %>
                  <div class="text-muted small">Keine Bilder vorhanden.</div>
                <% } %>
              </div>

              <div>
                <div class="fw-semibold mb-2">Manuals</div>
                <% if (manuals.length) { %>
                  <div class="list-group">
                    <% manuals.forEach(function(file) { %>
                      <form method="post" action="/admin/asset-models/<%= safeModel.id %>/attachments/<%= file.id %>" class="list-group-item">
                        <input type="hidden" name="csrfToken" value="<%= csrfToken || '' %>">
                        <div class="row g-2 align-items-center">
                          <div class="col-md-5"><input type="text" name="title" class="form-control form-control-sm" value="<%= file.title || '' %>" placeholder="Titel"></div>
                          <div class="col-md-3"><select name="kind" class="form-select form-select-sm"><option value="image">image</option><option value="manual" selected>manual</option><option value="document">document</option><option value="other">other</option></select></div>
                          <div class="col-md-2"><a class="btn btn-outline-secondary btn-sm w-100" href="<%= file.url %>" target="_blank" rel="noreferrer">Öffnen</a></div>
                          <div class="col-md-2 d-flex justify-content-end gap-2"><button type="submit" class="btn btn-outline-primary btn-sm"><i class="bi bi-check2"></i></button><button type="submit" formaction="/admin/asset-models/<%= safeModel.id %>/attachments/<%= file.id %>/delete" formmethod="post" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash3-fill"></i></button></div>
                        </div>
                      </form>
                    <% }) %>
                  </div>
                <% } else { %>
                  <div class="text-muted small">Keine Manuals vorhanden.</div>
                <% } %>
              </div>

              <div>
                <div class="fw-semibold mb-2">Documents</div>
                <% if (documents.length) { %>
                  <div class="list-group">
                    <% documents.forEach(function(file) { %>
                      <form method="post" action="/admin/asset-models/<%= safeModel.id %>/attachments/<%= file.id %>" class="list-group-item">
                        <input type="hidden" name="csrfToken" value="<%= csrfToken || '' %>">
                        <div class="row g-2 align-items-center">
                          <div class="col-md-5"><input type="text" name="title" class="form-control form-control-sm" value="<%= file.title || '' %>" placeholder="Titel"></div>
                          <div class="col-md-3"><select name="kind" class="form-select form-select-sm"><option value="image">image</option><option value="manual">manual</option><option value="document" selected>document</option><option value="other">other</option></select></div>
                          <div class="col-md-2"><a class="btn btn-outline-secondary btn-sm w-100" href="<%= file.url %>" target="_blank" rel="noreferrer">Öffnen</a></div>
                          <div class="col-md-2 d-flex justify-content-end gap-2"><button type="submit" class="btn btn-outline-primary btn-sm"><i class="bi bi-check2"></i></button><button type="submit" formaction="/admin/asset-models/<%= safeModel.id %>/attachments/<%= file.id %>/delete" formmethod="post" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash3-fill"></i></button></div>
                        </div>
                      </form>
                    <% }) %>
                  </div>
                <% } else { %>
                  <div class="text-muted small">Keine Documents vorhanden.</div>
                <% } %>
              </div>

              <div>
                <div class="fw-semibold mb-2">Other</div>
                <% if (others.length) { %>
                  <div class="list-group">
                    <% others.forEach(function(file) { %>
                      <form method="post" action="/admin/asset-models/<%= safeModel.id %>/attachments/<%= file.id %>" class="list-group-item">
                        <input type="hidden" name="csrfToken" value="<%= csrfToken || '' %>">
                        <div class="row g-2 align-items-center">
                          <div class="col-md-5"><input type="text" name="title" class="form-control form-control-sm" value="<%= file.title || '' %>" placeholder="Titel"></div>
                          <div class="col-md-3"><select name="kind" class="form-select form-select-sm"><option value="image">image</option><option value="manual">manual</option><option value="document">document</option><option value="other" selected>other</option></select></div>
                          <div class="col-md-2"><a class="btn btn-outline-secondary btn-sm w-100" href="<%= file.url %>" target="_blank" rel="noreferrer">Öffnen</a></div>
                          <div class="col-md-2 d-flex justify-content-end gap-2"><button type="submit" class="btn btn-outline-primary btn-sm"><i class="bi bi-check2"></i></button><button type="submit" formaction="/admin/asset-models/<%= safeModel.id %>/attachments/<%= file.id %>/delete" formmethod="post" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash3-fill"></i></button></div>
                        </div>
                      </form>
                    <% }) %>
                  </div>
                <% } else { %>
                  <div class="text-muted small">Keine weiteren Anhänge vorhanden.</div>
                <% } %>
              </div>
            </div>
          <% } else { %>
            -
          <% } %>
        </dd>
      </dl>
    </div>
    <div class="card-footer d-flex justify-content-end">
      <form method="post" action="/admin/asset-models/<%= safeModel.id %>/delete">
        <input type="hidden" name="csrfToken" value="<%= csrfToken || '' %>">
        <button type="submit" class="btn btn-outline-danger">Löschen</button>
      </form>
    </div>
  </div>

  <% if ((safeModel.trackingType || 'serialized') === 'bulk') { %>
    <div class="card shadow-sm mt-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="h5 mb-0">Bulk-Bestand</h2>
        </div>
        <form method="post" action="/admin/asset-models/<%= safeModel.id %>/stock" class="row g-3">
          <input type="hidden" name="csrfToken" value="<%= csrfToken || '' %>">
          <div class="col-md-3">
            <label for="quantityTotal" class="form-label">Gesamtmenge</label>
            <input id="quantityTotal" name="quantityTotal" type="number" min="0" step="1" class="form-control" value="<%= safeStock ? safeStock.quantityTotal : 0 %>">
          </div>
          <div class="col-md-3">
            <label for="quantityAvailable" class="form-label">Verfügbar</label>
            <input id="quantityAvailable" name="quantityAvailable" type="number" min="0" step="1" class="form-control" value="<%= safeStock ? safeStock.quantityAvailable : 0 %>">
          </div>
          <div class="col-md-3">
            <label for="minThreshold" class="form-label">Min. Bestand</label>
            <input id="minThreshold" name="minThreshold" type="number" min="0" step="1" class="form-control" value="<%= safeStock && safeStock.minThreshold !== null ? safeStock.minThreshold : '' %>">
          </div>
          <div class="col-md-3">
            <label for="reorderThreshold" class="form-label">Meldebestand</label>
            <input id="reorderThreshold" name="reorderThreshold" type="number" min="0" step="1" class="form-control" value="<%= safeStock && safeStock.reorderThreshold !== null ? safeStock.reorderThreshold : '' %>">
          </div>
          <div class="col-12 d-flex justify-content-end">
            <button type="submit" class="btn btn-primary">Bestand speichern</button>
          </div>
        </form>
      </div>
    </div>
  <% } %>

  <% if ((safeModel.trackingType || 'serialized') === 'bundle') { %>
    <div class="card shadow-sm mt-4">
      <div class="card-body">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2 mb-3">
          <h2 class="h5 mb-0">Bundle-Komponenten</h2>
          <a href="/admin/asset-models/<%= safeModel.id %>/edit" class="btn btn-outline-primary btn-sm">In Bearbeiten verwalten</a>
        </div>
        <% if (safeBundleDefinition) { %>
          <div class="small text-muted mb-3">
            Name: <span class="fw-semibold"><%= safeBundleDefinition.name || safeModel.name %></span>
          </div>
          <% if (bundleItems.length) { %>
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Komponente</th>
                    <th>Typ</th>
                    <th>Menge</th>
                    <th>Pflicht</th>
                  </tr>
                </thead>
                <tbody>
                  <% bundleItems.forEach(function(item) { %>
                    <tr>
                      <td><%= item.componentModel ? item.componentModel.name : '-' %></td>
                      <td><%= item.componentModel ? (item.componentModel.trackingType || 'serialized') : '-' %></td>
                      <td><%= item.quantity || 1 %></td>
                      <td><%= item.isOptional ? 'Optional' : 'Pflicht' %></td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <p class="text-muted mb-0">Noch keine Komponenten hinterlegt.</p>
          <% } %>
        <% } else { %>
          <p class="text-muted mb-0">Noch keine Bundle-Definition vorhanden.</p>
        <% } %>
      </div>
    </div>
  <% } %>
</section>
