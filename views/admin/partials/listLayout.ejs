<%
  const query = (typeof filters !== 'undefined' && filters) ? filters : {};
  const currentPage = (pagination && pagination.page) ? pagination.page : 1;
  const listItems = Array.isArray(items) ? items : [];
  const totalItems = (pagination && pagination.total) ? pagination.total : listItems.length;
  const safeSectionClass = (typeof sectionClass !== 'undefined' && sectionClass) ? sectionClass : '';
  const safeHeading = (typeof heading !== 'undefined' && heading) ? heading : '';
  const safeSubheading = (typeof subheading !== 'undefined' && subheading) ? subheading : '';
  const safeFilterPartial = (typeof filterPartial !== 'undefined' && filterPartial) ? filterPartial : '';
  const safeFilterAction = (typeof filterAction !== 'undefined' && filterAction) ? filterAction : '';
  const safeManufacturers = (typeof manufacturers !== 'undefined') ? manufacturers : undefined;
  const safeCategories = (typeof categories !== 'undefined') ? categories : undefined;
  const safeCreateHref = (typeof createHref !== 'undefined') ? createHref : '';
  const safeCreateLabel = (typeof createLabel !== 'undefined') ? createLabel : '';
  const safeColumns = (typeof columns !== 'undefined') ? columns : [];
  const safeActions = (typeof actions !== 'undefined') ? actions : {};
  const safeEmptyMessage = (typeof emptyMessage !== 'undefined') ? emptyMessage : 'Keine Einträge vorhanden.';
  const safeTablePartial = (typeof tablePartial !== 'undefined' && tablePartial) ? tablePartial : './listTable';
  const sortBy = query.sortBy || '';
  const sortOrder = query.sortOrder || 'ASC';
  const safeIncludeDeletedOnLabel = (typeof includeDeletedOnLabel !== 'undefined' && includeDeletedOnLabel)
    ? includeDeletedOnLabel
    : 'Nur aktive anzeigen';
  const safeIncludeDeletedOffLabel = (typeof includeDeletedOffLabel !== 'undefined' && includeDeletedOffLabel)
    ? includeDeletedOffLabel
    : 'Gelöschte anzeigen';
  const includeDeleted = query.includeDeleted === '1' || query.includeDeleted === 'true' || query.includeDeleted === 'yes';
  const includeDeletedToggleLabel = includeDeleted
    ? safeIncludeDeletedOnLabel
    : safeIncludeDeletedOffLabel;

  const buildQuery = function (overrides) {
    const params = Object.assign({}, query, overrides || {});
    const parts = [];
    Object.keys(params).forEach(function (key) {
      const value = params[key];
      if (typeof value !== 'undefined' && value !== null && value !== '') {
        parts.push(encodeURIComponent(key) + '=' + encodeURIComponent(String(value)));
      }
    });
    return parts.length ? ('?' + parts.join('&')) : '';
  };

  const sortLink = function (field) {
    const nextOrder = (sortBy === field && sortOrder === 'ASC') ? 'DESC' : 'ASC';
    return buildQuery({ sortBy: field, sortOrder: nextOrder, page: 1 });
  };

  const includeDeletedLink = buildQuery({ includeDeleted: includeDeleted ? '' : '1', page: 1 });
%>

<section class="admin <%= safeSectionClass %>">
  <div class="d-flex flex-column flex-lg-row align-items-lg-end justify-content-between gap-3 mb-4">
    <div>
      <h1 class="h3 mb-2"><%= safeHeading %></h1>
      <% if (safeSubheading) { %>
        <p class="text-muted mb-0"><%= safeSubheading %></p>
      <% } %>
    </div>
  </div>

  <% if (safeFilterPartial) { %>
    <%- include(safeFilterPartial, {
      query,
      includeDeleted,
      buildQuery,
      filterAction: safeFilterAction,
      manufacturers: safeManufacturers,
      categories: safeCategories,
    }) %>
  <% } %>

  <form class="mb-4 panel">
    <input type="hidden" name="csrfToken" value="<%= csrfToken || '' %>">
    <input type="hidden" name="includeDeleted" value="<%= includeDeleted ? '1' : '' %>">

    <%- include('./listToolbar', {
      toolbarClass: 'mb-3',
      currentPage,
      pagination,
      buildQuery,
      createHref: safeCreateHref,
      createLabel: safeCreateLabel,
      includeDeletedLink,
      includeDeletedToggleLabel,
      totalItems,
    }) %>

    <%- include(safeTablePartial, {
      rows: listItems,
      columns: safeColumns,
      actions: safeActions,
      sortLink,
      emptyMessage: safeEmptyMessage,
    }) %>

    <%- include('./listToolbar', {
      toolbarClass: 'mt-3',
      currentPage,
      pagination,
      buildQuery,
      createHref: safeCreateHref,
      createLabel: safeCreateLabel,
      includeDeletedLink,
      includeDeletedToggleLabel,
      totalItems,
    }) %>
  </form>
</section>
