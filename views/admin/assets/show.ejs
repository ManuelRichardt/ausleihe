<% pageTitle = 'Asset' %>
<%
  const safeAsset = (typeof asset !== 'undefined' && asset) ? asset : {};
  const modelName = safeAsset.model ? safeAsset.model.name : '-';
  const manufacturerName = safeAsset.model && safeAsset.model.manufacturer ? safeAsset.model.manufacturer.name : '-';
  const categoryName = safeAsset.model && safeAsset.model.category ? safeAsset.model.category.name : '-';
  const storageLocationName = safeAsset.storageLocation ? safeAsset.storageLocation.name : '-';
  const maintenanceList = Array.isArray(safeAsset.maintenances) ? safeAsset.maintenances : [];
  const fmt = function (value) {
    if (!value) return '-';
    const d = value instanceof Date ? value : new Date(value);
    if (Number.isNaN(d.getTime())) return '-';
    const p = function (n) { return String(n).padStart(2, '0'); };
    return p(d.getDate()) + '.' + p(d.getMonth() + 1) + '.' + d.getFullYear() + ' - ' + p(d.getHours()) + ':' + p(d.getMinutes());
  };
%>

<section class="admin assets">
  <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="h3 mb-1"><%= safeAsset.inventoryNumber || 'Asset' %></h1>
      <p class="text-muted mb-0">Modell: <%= modelName %></p>
    </div>
    <div class="d-flex gap-2">
      <a href="/admin/assets" class="btn btn-outline-secondary">Zur Übersicht</a>
      <a href="/admin/assets/<%= safeAsset.id %>/edit" class="btn btn-primary">Bearbeiten</a>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <dl class="row mb-0">
        <dt class="col-sm-3">Inventarnummer</dt>
        <dd class="col-sm-9"><%= safeAsset.inventoryNumber || '-' %></dd>
        <dt class="col-sm-3">Seriennummer</dt>
        <dd class="col-sm-9"><%= safeAsset.serialNumber || '-' %></dd>
        <dt class="col-sm-3">Modell</dt>
        <dd class="col-sm-9"><%= modelName %></dd>
        <dt class="col-sm-3">Hersteller</dt>
        <dd class="col-sm-9"><%= manufacturerName %></dd>
        <dt class="col-sm-3">Kategorie</dt>
        <dd class="col-sm-9"><%= categoryName %></dd>
        <dt class="col-sm-3">Lagerort</dt>
        <dd class="col-sm-9"><%= storageLocationName %></dd>
        <dt class="col-sm-3">Zustand</dt>
        <dd class="col-sm-9"><%= safeAsset.condition || '-' %></dd>
        <dt class="col-sm-3">Ausleihbar</dt>
        <dd class="col-sm-9">
          <% if (safeAsset.isActive) { %>
            <span class="badge text-bg-success">Ja</span>
          <% } else { %>
            <span class="badge text-bg-danger">Nein</span>
          <% } %>
        </dd>
      </dl>
    </div>
    <div class="card-footer d-flex justify-content-end">
      <form method="post" action="/admin/assets/<%= safeAsset.id %>/delete">
        <input type="hidden" name="csrfToken" value="<%= csrfToken || '' %>">
        <button type="submit" class="btn btn-outline-danger">Löschen</button>
      </form>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
      <h2 class="h5 mb-0">Wartungsverlauf</h2>
    </div>
    <div class="card-body">
      <form method="post" action="/admin/assets/<%= safeAsset.id %>/maintenance/report" class="row g-2 mb-3">
        <input type="hidden" name="csrfToken" value="<%= csrfToken || '' %>">
        <div class="col-md-9">
          <input type="text" class="form-control" name="notes" placeholder="Notiz zur Meldung (optional)">
        </div>
        <div class="col-md-3 d-grid">
          <button type="submit" class="btn btn-outline-primary">Wartung melden</button>
        </div>
      </form>

      <% if (maintenanceList.length) { %>
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>Status</th>
                <th>Gemeldet</th>
                <th>Abgeschlossen</th>
                <th>Notizen</th>
                <th>Aktionen</th>
              </tr>
            </thead>
            <tbody>
              <% maintenanceList.forEach(function(entry) { %>
                <tr>
                  <td>
                    <% if (entry.status === 'reported') { %>
                      <span class="badge text-bg-warning">reported</span>
                    <% } else if (entry.status === 'in_progress') { %>
                      <span class="badge text-bg-primary">in_progress</span>
                    <% } else if (entry.status === 'completed') { %>
                      <span class="badge text-bg-success">completed</span>
                    <% } else { %>
                      <span class="badge text-bg-secondary"><%= entry.status %></span>
                    <% } %>
                  </td>
                  <td><%= fmt(entry.reportedAt) %></td>
                  <td><%= fmt(entry.completedAt) %></td>
                  <td style="white-space: pre-wrap;"><%= entry.notes || '-' %></td>
                  <td>
                    <% if (entry.status === 'reported') { %>
                      <form method="post" action="/admin/assets/<%= safeAsset.id %>/maintenance/<%= entry.id %>/start" class="d-flex gap-2 mb-2">
                        <input type="hidden" name="csrfToken" value="<%= csrfToken || '' %>">
                        <input type="text" class="form-control form-control-sm" name="notes" placeholder="Start-Notiz">
                        <button type="submit" class="btn btn-sm btn-outline-primary">Starten</button>
                      </form>
                      <form method="post" action="/admin/assets/<%= safeAsset.id %>/maintenance/<%= entry.id %>/complete" class="d-flex gap-2">
                        <input type="hidden" name="csrfToken" value="<%= csrfToken || '' %>">
                        <input type="text" class="form-control form-control-sm" name="notes" placeholder="Abschluss-Notiz">
                        <button type="submit" class="btn btn-sm btn-outline-success">Abschließen</button>
                      </form>
                    <% } else if (entry.status === 'in_progress') { %>
                      <form method="post" action="/admin/assets/<%= safeAsset.id %>/maintenance/<%= entry.id %>/complete" class="d-flex gap-2">
                        <input type="hidden" name="csrfToken" value="<%= csrfToken || '' %>">
                        <input type="text" class="form-control form-control-sm" name="notes" placeholder="Abschluss-Notiz">
                        <button type="submit" class="btn btn-sm btn-outline-success">Abschließen</button>
                      </form>
                    <% } else { %>
                      <span class="text-muted small">Keine Aktion</span>
                    <% } %>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } else { %>
        <p class="text-muted mb-0">Keine Wartungseinträge vorhanden.</p>
      <% } %>
    </div>
  </div>
</section>
