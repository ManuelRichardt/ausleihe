<% pageTitle = 'Reservierungsdetails' %>
<% const safeFormatDateTime = (typeof formatDateTime === 'function') ? formatDateTime : function () { return '-'; }; %>
<% const safeCsrf = (typeof csrfToken !== 'undefined' && csrfToken) ? csrfToken : ''; %>
<%
  const toItemQuantity = function (item) {
    const parsed = parseInt(item && item.quantity, 10);
    return Number.isNaN(parsed) || parsed < 1 ? 1 : parsed;
  };
%>
<section>
  <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="h3 mb-1">Reservierungsdetails</h1>
      <p class="text-muted mb-0">ID: <%= reservation.id %></p>
    </div>
    <a class="btn btn-outline-secondary" href="/reservations">Zur√ºck</a>
  </div>

  <div class="row g-4">
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <dl class="row mb-0">
            <dt class="col-sm-4 text-muted">Ausleihe</dt>
            <dd class="col-sm-8"><%= reservation.lendingLocation ? reservation.lendingLocation.name : '-' %></dd>
            <dt class="col-sm-4 text-muted">Von</dt>
            <dd class="col-sm-8"><%= safeFormatDateTime(reservation.reservedFrom) %></dd>
            <dt class="col-sm-4 text-muted">Bis</dt>
            <dd class="col-sm-8"><%= safeFormatDateTime(reservation.reservedUntil) %></dd>
            <dt class="col-sm-4 text-muted">Status</dt>
            <dd class="col-sm-8">
              <span class="badge <%= reservation.status === 'reserved' ? 'text-bg-primary' : (reservation.status === 'cancelled' ? 'text-bg-secondary' : 'text-bg-light') %>">
                <%= reservation.status %>
              </span>
            </dd>
          </dl>
        </div>
      </div>
      <% if (reservation.status === 'reserved') { %>
        <div class="card shadow-sm mt-3">
          <div class="card-header bg-white">
            <h2 class="h6 mb-0">Reservierung stornieren</h2>
          </div>
          <div class="card-body">
            <form method="post" action="/reservations/<%= reservation.id %>/cancel">
              <input type="hidden" name="csrfToken" value="<%= safeCsrf %>">
              <div class="mb-3">
                <label class="form-label" for="note">Notiz (optional)</label>
                <textarea class="form-control" id="note" name="note" rows="3"></textarea>
              </div>
              <button type="submit" class="btn btn-outline-danger w-100">Reservierung stornieren</button>
            </form>
          </div>
        </div>
      <% } %>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h2 class="h6 mb-0">Reservierte Modelle</h2>
        </div>
        <div class="card-body p-0">
          <%
            const grouped = {};
            (reservation.loanItems || []).forEach(function (item) {
              const model = item.assetModel || (item.asset && item.asset.model) || null;
              const key = model ? model.id : 'unknown';
              if (!grouped[key]) {
                grouped[key] = { model: model, quantity: 0 };
              }
              grouped[key].quantity += toItemQuantity(item);
            });
            const groupedItems = Object.values(grouped);
          %>
          <% if (groupedItems.length) { %>
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Modell</th>
                    <th>Hersteller</th>
                    <th class="text-end">Menge</th>
                  </tr>
                </thead>
                <tbody>
                  <% groupedItems.forEach(function (entry) { %>
                    <tr>
                      <td><%= entry.model ? entry.model.name : 'Unbekanntes Modell' %></td>
                      <td><%= entry.model && entry.model.manufacturer ? entry.model.manufacturer.name : '-' %></td>
                      <td class="text-end"><span class="badge text-bg-primary"><%= entry.quantity %></span></td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="p-3 text-muted">Keine reservierten Items vorhanden.</div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</section>
