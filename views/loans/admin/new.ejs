<% pageTitle = 'Ausleihe erstellen' %>
<% const safeCsrf = (typeof csrfToken !== 'undefined' && csrfToken) ? csrfToken : ''; %>
<% const safeFormData = (typeof formData !== 'undefined' && formData) ? formData : {}; %>
<% const safeErrors = (typeof errors !== 'undefined' && errors) ? errors : {}; %>
<% const safeSelectedAssets = Array.isArray(selectedAssets) ? selectedAssets : []; %>
<section class="admin-loan-new">
  <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="h3 mb-1">Neue Ausleihe</h1>
      <p class="text-muted mb-0">Ausleihe f체r registrierte oder externe Benutzer erstellen.</p>
    </div>
    <a class="btn btn-outline-secondary" href="/admin/loans">Zur체ck</a>
  </div>

  <form method="post" action="/admin/loans/new" class="card shadow-sm" id="loanCreateForm">
    <input type="hidden" name="csrfToken" value="<%= safeCsrf %>">
    <input type="hidden" name="selectedAssetsJson" id="selectedAssetsJson" value="">
    <div id="selectedAssetHiddenInputs"></div>
    <div class="card-body">
      <% if (safeErrors.form) { %>
        <div class="alert alert-danger"><%= safeErrors.form %></div>
      <% } %>
      <div class="row g-3">
        <div class="col-12">
          <label class="form-label d-block mb-2">Benutzer</label>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="borrowerType" id="borrowerTypeExisting" value="existing" <%= safeFormData.borrowerType === 'guest' ? '' : 'checked' %>>
            <label class="form-check-label" for="borrowerTypeExisting">Registrierter Benutzer</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="borrowerType" id="borrowerTypeGuest" value="guest" <%= safeFormData.borrowerType === 'guest' ? 'checked' : '' %>>
            <label class="form-check-label" for="borrowerTypeGuest">Nicht registrierter Benutzer</label>
          </div>
        </div>

        <div class="col-12 position-relative" id="existingBorrowerBlock">
          <label class="form-label" for="borrowerSearch">Benutzer suchen</label>
          <input type="text" id="borrowerSearch" name="borrowerQuery" class="form-control <%= safeErrors.userId ? 'is-invalid' : '' %>" value="<%= safeFormData.borrowerQuery || '' %>" autocomplete="off" placeholder="Name, Benutzername oder E-Mail">
          <input type="hidden" id="userId" name="userId" value="<%= safeFormData.userId || '' %>">
          <div class="list-group position-absolute w-100 d-none" id="borrowerSuggestions"></div>
          <% if (safeErrors.userId) { %>
            <div class="invalid-feedback d-block"><%= safeErrors.userId %></div>
          <% } %>
        </div>

        <div class="col-md-4 d-none" id="guestFirstNameBlock">
          <label class="form-label" for="guestFirstName">Vorname</label>
          <input type="text" id="guestFirstName" name="guestFirstName" class="form-control <%= safeErrors.guestFirstName ? 'is-invalid' : '' %>" value="<%= safeFormData.guestFirstName || '' %>">
          <% if (safeErrors.guestFirstName) { %>
            <div class="invalid-feedback"><%= safeErrors.guestFirstName %></div>
          <% } %>
        </div>
        <div class="col-md-4 d-none" id="guestLastNameBlock">
          <label class="form-label" for="guestLastName">Nachname</label>
          <input type="text" id="guestLastName" name="guestLastName" class="form-control <%= safeErrors.guestLastName ? 'is-invalid' : '' %>" value="<%= safeFormData.guestLastName || '' %>">
          <% if (safeErrors.guestLastName) { %>
            <div class="invalid-feedback"><%= safeErrors.guestLastName %></div>
          <% } %>
        </div>
        <div class="col-md-4 d-none" id="guestEmailBlock">
          <label class="form-label" for="guestEmail">E-Mail</label>
          <input type="email" id="guestEmail" name="guestEmail" class="form-control <%= safeErrors.guestEmail ? 'is-invalid' : '' %>" value="<%= safeFormData.guestEmail || '' %>">
          <% if (safeErrors.guestEmail) { %>
            <div class="invalid-feedback"><%= safeErrors.guestEmail %></div>
          <% } %>
        </div>

        <div class="col-md-4">
          <label class="form-label" for="reservedFrom">Von</label>
          <input type="datetime-local" id="reservedFrom" name="reservedFrom" class="form-control <%= safeErrors.reservedFrom ? 'is-invalid' : '' %>" value="<%= safeFormData.reservedFrom || '' %>">
          <% if (safeErrors.reservedFrom) { %>
            <div class="invalid-feedback"><%= safeErrors.reservedFrom %></div>
          <% } %>
        </div>
        <div class="col-md-4">
          <label class="form-label" for="reservedUntil">Bis</label>
          <input type="datetime-local" id="reservedUntil" name="reservedUntil" class="form-control <%= safeErrors.reservedUntil ? 'is-invalid' : '' %>" value="<%= safeFormData.reservedUntil || '' %>">
          <% if (safeErrors.reservedUntil) { %>
            <div class="invalid-feedback"><%= safeErrors.reservedUntil %></div>
          <% } %>
        </div>
        <div class="col-md-4">
          <label class="form-label" for="loanNotes">Notiz</label>
          <input type="text" id="loanNotes" name="notes" class="form-control" value="<%= safeFormData.notes || '' %>" placeholder="Optional">
        </div>
      </div>

      <hr class="my-4">

      <div class="row g-2 align-items-end">
        <div class="col-md-8 position-relative">
          <label class="form-label" for="assetSearch">Asset hinzuf체gen</label>
          <input type="text" id="assetSearch" class="form-control <%= safeErrors.selectedAssets ? 'is-invalid' : '' %>" autocomplete="off" placeholder="Inventarnummer, Modell, Hersteller">
          <div class="list-group position-absolute w-100 d-none" id="assetSuggestions"></div>
          <% if (safeErrors.selectedAssets) { %>
            <div class="invalid-feedback d-block"><%= safeErrors.selectedAssets %></div>
          <% } %>
        </div>
        <div class="col-md-4 d-flex gap-2">
          <button type="button" id="assetQuickscanButton" class="btn btn-outline-secondary w-100 js-quickscan-open" data-scan-mode="create">
            <i class="bi bi-upc-scan me-1"></i>Quickscan
          </button>
        </div>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-hover align-middle" id="selectedAssetsTable">
          <thead class="table-light">
            <tr>
              <th>Typ</th>
              <th>Inventarnummer</th>
              <th>Seriennummer</th>
              <th>Modell</th>
              <th>Hersteller</th>
              <th>Menge</th>
              <th class="text-end">Aktion</th>
            </tr>
          </thead>
          <tbody>
            <% if (safeSelectedAssets.length) { %>
              <% safeSelectedAssets.forEach(function (asset) { %>
                <% const isBulk = String(asset.kind || asset.trackingType || '').toLowerCase() === 'bulk'; %>
                <tr>
                  <td><span class="badge <%= isBulk ? 'text-bg-warning' : 'text-bg-primary' %>"><%= isBulk ? 'Bulk' : 'Asset' %></span></td>
                  <td><%= isBulk ? '-' : (asset.inventoryNumber || '-') %></td>
                  <td><%= isBulk ? '-' : (asset.serialNumber || '-') %></td>
                  <td><%= asset.modelName || '-' %></td>
                  <td><%= asset.manufacturerName || '-' %></td>
                  <td><%= isBulk ? (asset.quantity || 1) : 1 %></td>
                  <td class="text-end"><span class="text-muted small">Wird beim Laden aktualisiert</span></td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr class="empty-row">
                <td colspan="7" class="text-center text-muted py-3">Noch keine Assets ausgew채hlt.</td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
    <div class="card-footer d-flex justify-content-end gap-2">
      <button type="submit" class="btn btn-primary">Ausleihe erstellen</button>
      <a href="/admin/loans" class="btn btn-outline-secondary">Abbrechen</a>
    </div>
  </form>
</section>

<script id="loanCreateSelectedAssetsSeed" type="application/json"><%- JSON.stringify(safeSelectedAssets) %></script>
<%- include('../../partials/quickScanModal') %>
<script src="/js/quickScan.js"></script>
<script src="/js/loanCreate.js"></script>
