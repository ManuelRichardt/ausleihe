<% pageTitle = 'Rücknahme' %>
<% const safeCsrf = (typeof csrfToken !== 'undefined' && csrfToken) ? csrfToken : ''; %>
<% const safeFormatDateTime = (typeof formatDateTime === 'function') ? formatDateTime : function () { return '-'; }; %>
<%
  const currentUser = (typeof user !== 'undefined' && user) ? user : null;
  const returnSignerName = currentUser ? ([currentUser.firstName, currentUser.lastName].filter(Boolean).join(' ') || currentUser.username) : '';
  const now = new Date();
  const signedAtValue = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
%>
<section class="admin-loan-return">
  <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="h3 mb-1">Rücknahme</h1>
      <p class="text-muted mb-0">ID: <%= loan.id %></p>
    </div>
    <a class="btn btn-outline-secondary" href="/admin/loans/<%= loan.id %>">Zurück zu Ausleihdetails</a>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <div class="small text-muted">Nutzer</div>
          <div class="fw-semibold"><%= loan.user ? [loan.user.firstName, loan.user.lastName].filter(Boolean).join(' ') || loan.user.username : '-' %></div>
        </div>
        <div class="col-md-4">
          <div class="small text-muted">E-Mail</div>
          <div class="fw-semibold"><%= loan.user ? loan.user.email || '-' : '-' %></div>
        </div>
        <div class="col-md-4">
          <div class="small text-muted">Ausleihe</div>
          <div class="fw-semibold"><%= loan.lendingLocation ? loan.lendingLocation.name : '-' %></div>
        </div>
      </div>
      <div class="row g-3 mt-1">
        <div class="col-md-6">
          <div class="small text-muted">Von</div>
          <div class="fw-semibold"><%= safeFormatDateTime(loan.reservedFrom) %></div>
        </div>
        <div class="col-md-6">
          <div class="small text-muted">Bis</div>
          <div class="fw-semibold"><%= safeFormatDateTime(loan.reservedUntil) %></div>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex flex-wrap gap-2 justify-content-end mb-2">
    <button type="button" class="btn btn-outline-secondary"><i class="bi bi-upc-scan me-1"></i>Quickscan</button>
    <a class="btn btn-outline-primary" href="/loans/<%= loan.id %>/print?format=pdf" target="_blank" rel="noopener"><i class="bi bi-printer me-1"></i>Ausleihzettel drucken</a>
    <button type="submit" form="returnItemsForm" class="btn btn-success"><i class="bi bi-check2-circle me-1"></i>Ausgewählte zurücknehmen</button>
  </div>

  <form method="post" id="returnItemsForm" action="/admin/loans/<%= loan.id %>/return-items" class="card shadow-sm">
    <input type="hidden" name="csrfToken" value="<%= safeCsrf %>">
    <input type="hidden" name="signatureBase64" id="returnSignatureBase64" value="">
    <input type="hidden" name="signedByName" value="<%= returnSignerName %>">
    <input type="hidden" name="signedAt" value="<%= signedAtValue %>">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th><input type="checkbox" id="returnSelectAll"></th>
            <th>Inventarnummer</th>
            <th>Modell</th>
            <th>Hersteller</th>
            <th>Zustand</th>
            <th>Vollständigkeit</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <% if (Array.isArray(loan.loanItems) && loan.loanItems.length) { %>
            <% loan.loanItems.forEach(function (item, idx) { %>
              <%
                const model = item.assetModel || (item.asset && item.asset.model) || null;
                const manufacturer = model && model.manufacturer ? model.manufacturer : null;
              %>
              <tr>
                <td><input type="checkbox" name="itemIds" value="<%= item.id %>" class="return-item-checkbox"></td>
                <td><%= item.asset ? (item.asset.inventoryNumber || item.asset.serialNumber || item.asset.id) : '-' %></td>
                <td><%= model ? model.name : '-' %></td>
                <td><%= manufacturer ? manufacturer.name : '-' %></td>
                <td>
                  <input type="hidden" name="items[<%= idx %>][loanItemId]" value="<%= item.id %>">
                  <select class="form-select form-select-sm" name="items[<%= idx %>][conditionOnReturn]">
                    <option value="new">new</option>
                    <option value="good" selected>good</option>
                    <option value="fair">fair</option>
                    <option value="damaged">damaged</option>
                    <option value="lost">lost</option>
                  </select>
                </td>
                <td>
                  <select class="form-select form-select-sm" name="items[<%= idx %>][completeness]">
                    <option value="complete" selected>Vollständig</option>
                    <option value="incomplete">Nicht Vollständig</option>
                  </select>
                </td>
                <td>
                  <select class="form-select form-select-sm" name="items[<%= idx %>][assetStatus]">
                    <option value="active" selected>Aktiv</option>
                    <option value="inactive">Inaktiv</option>
                  </select>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr>
              <td colspan="7" class="text-center text-muted py-4">Keine Items vorhanden.</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
    <div class="card-body border-top">
      <div class="row g-3">
        <div class="col-12">
          <label for="returnNote" class="form-label">Notiz zur Rücknahme</label>
          <textarea id="returnNote" name="note" rows="2" class="form-control" placeholder="Optional"></textarea>
        </div>
        <div class="col-12">
          <label for="returnSignatureCanvas" class="form-label">Unterschrift Labor</label>
          <div class="border rounded p-2">
            <canvas id="returnSignatureCanvas" width="600" height="180" class="w-100" aria-label="Unterschrift Labor"></canvas>
          </div>
          <div class="d-flex flex-wrap gap-2 mt-2">
            <button id="returnSignatureClear" type="button" class="btn btn-outline-secondary btn-sm">Leeren</button>
          </div>
        </div>
      </div>
    </div>
  </form>

  <div class="d-flex flex-wrap gap-2 justify-content-end mt-2">
    <button type="button" class="btn btn-outline-secondary"><i class="bi bi-upc-scan me-1"></i>Quickscan</button>
    <a class="btn btn-outline-primary" href="/loans/<%= loan.id %>/print?format=pdf" target="_blank" rel="noopener"><i class="bi bi-printer me-1"></i>Ausleihzettel drucken</a>
    <button type="submit" form="returnItemsForm" class="btn btn-success"><i class="bi bi-check2-circle me-1"></i>Ausgewählte zurücknehmen</button>
  </div>
</section>
<script src="/js/loan-return-signature.js"></script>
