<% pageTitle = 'Signatur' %>
<%
  const safeLoan = (typeof loan !== 'undefined' && loan) ? loan : { id: '' };
  const safeLoanBasePath = (typeof loanBasePath !== 'undefined' && loanBasePath) ? loanBasePath : '/loans/' + safeLoan.id;
  const safeCsrf = (typeof csrfToken !== 'undefined' && csrfToken) ? csrfToken : '';
  const currentUser = (typeof user !== 'undefined' && user) ? user : null;
  const defaultName = currentUser ? [currentUser.firstName, currentUser.lastName].filter(Boolean).join(' ') || currentUser.username : '';
  const submittedDate = (typeof formData !== 'undefined' && formData && formData.signedAt) ? formData.signedAt : '';
  const nowDate = new Date();
  const signedAtDefault = submittedDate || `${nowDate.getFullYear()}-${String(nowDate.getMonth() + 1).padStart(2, '0')}-${String(nowDate.getDate()).padStart(2, '0')}`;
%>
<section class="loan-sign">
  <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="h3 mb-1">Signatur</h1>
      <p class="text-muted mb-0">Digitale Unterschrift f√ºr die Ausleihe.</p>
    </div>
    <a class="btn btn-outline-secondary" href="<%= safeLoanBasePath %>">Zurueck</a>
  </div>

  <form method="post" action="/loans/<%= safeLoan.id %>/sign" class="card shadow-sm" id="signatureForm">
    <input type="hidden" name="csrfToken" value="<%= safeCsrf %>">
    <input type="hidden" name="loanId" value="<%= safeLoan.id %>">
    <input type="hidden" name="signatureBase64" id="signatureBase64" value="">

    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <%- include('../partials/forms/select', {
            name: 'signatureType',
            label: 'Signaturtyp',
            required: true,
            options: [
              { value: 'handover', label: 'Uebergabe' },
              { value: 'return', label: 'Rueckgabe' }
            ],
            value: (typeof formData !== 'undefined' && formData && formData.signatureType) ? formData.signatureType : signatureType
          }) %>
        </div>
        <div class="col-md-6">
          <%- include('../partials/forms/date', { name: 'signedAt', label: 'Datum', value: signedAtDefault }) %>
        </div>
        <div class="col-12">
          <%- include('../partials/forms/input', { name: 'signedByName', label: 'Name', value: ((typeof formData !== 'undefined' && formData && formData.signedByName) ? formData.signedByName : '') || defaultName, required: true }) %>
        </div>
        <div class="col-12">
          <label for="signatureCanvas" class="form-label">Unterschrift</label>
          <div class="border rounded p-2">
            <canvas id="signatureCanvas" width="600" height="200" class="w-100" aria-label="Signaturfeld"></canvas>
          </div>
          <div class="d-flex flex-wrap gap-2 mt-2">
            <button id="signatureClear" type="button" class="btn btn-outline-secondary btn-sm">Leeren</button>
            <button id="signatureSave" type="button" class="btn btn-outline-primary btn-sm">Signatur uebernehmen</button>
          </div>
          <% if (typeof errors !== 'undefined' && errors && errors.signatureBase64) { %>
            <div class="text-danger small mt-2" role="alert"><%= errors.signatureBase64 %></div>
          <% } %>
        </div>
      </div>
    </div>
    <div class="card-footer d-flex justify-content-end gap-2">
      <button type="submit" class="btn btn-primary">Speichern</button>
    </div>
  </form>
</section>
<script src="/js/signature.js"></script>
