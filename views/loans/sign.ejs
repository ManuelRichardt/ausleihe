<% pageTitle = 'Signatur' %>
<%
  const safeLoan = (typeof loan !== 'undefined' && loan) ? loan : { id: '' };
  const safeLoanBasePath = (typeof loanBasePath !== 'undefined' && loanBasePath) ? loanBasePath : '/loans/' + safeLoan.id;
  const safeCsrf = (typeof csrfToken !== 'undefined' && csrfToken) ? csrfToken : '';
  const safeSignatureType = (typeof signatureType !== 'undefined' && signatureType) ? signatureType : 'handover';
  const safeSignedByNameDefault = (typeof signedByNameDefault !== 'undefined' && signedByNameDefault) ? signedByNameDefault : '';
  const safeHandoverSignerName = (typeof handoverSignerName !== 'undefined' && handoverSignerName) ? handoverSignerName : safeSignedByNameDefault;
  const safeReturnSignerName = (typeof returnSignerName !== 'undefined' && returnSignerName) ? returnSignerName : safeSignedByNameDefault;
  const submittedSignedAt = (typeof formData !== 'undefined' && formData && formData.signedAt) ? formData.signedAt : '';
  const signedAtSource = submittedSignedAt || new Date();
  const signedAtDate = signedAtSource instanceof Date ? signedAtSource : new Date(signedAtSource);
  const safeSignedAtDate = Number.isNaN(signedAtDate.getTime()) ? new Date() : signedAtDate;
  const signedAtDefault = `${safeSignedAtDate.getFullYear()}-${String(safeSignedAtDate.getMonth() + 1).padStart(2, '0')}-${String(safeSignedAtDate.getDate()).padStart(2, '0')}T${String(safeSignedAtDate.getHours()).padStart(2, '0')}:${String(safeSignedAtDate.getMinutes()).padStart(2, '0')}`;
%>
<section class="loan-sign">
  <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="h3 mb-1">Signatur</h1>
      <p class="text-muted mb-0">Digitale Unterschrift für die Ausleihe.</p>
    </div>
    <a class="btn btn-outline-secondary" href="<%= safeLoanBasePath %>">Zurueck</a>
  </div>

  <form method="post" action="/loans/<%= safeLoan.id %>/sign" class="card shadow-sm" id="signatureForm">
    <input type="hidden" name="csrfToken" value="<%= safeCsrf %>">
    <input type="hidden" name="loanId" value="<%= safeLoan.id %>">
    <input type="hidden" name="signatureBase64" id="signatureBase64" value="">

    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <%- include('../partials/forms/select', {
            id: 'signatureType',
            name: 'signatureType',
            label: 'Signaturtyp',
            required: true,
            options: [
              { value: 'handover', label: 'Uebergabe' },
              { value: 'return', label: 'Rueckgabe' }
            ],
            value: safeSignatureType
          }) %>
        </div>
        <div class="col-md-6">
          <%- include('../partials/forms/field', {
            as: 'input',
            type: 'datetime-local',
            name: 'signedAt',
            label: 'Zeitpunkt',
            value: signedAtDefault
          }) %>
        </div>
        <div class="col-12">
          <%- include('../partials/forms/input', { id: 'signedByName', name: 'signedByName', label: 'Name', value: safeSignedByNameDefault, required: true, readonly: true, helpText: 'Der Name wird abhängig vom Signaturtyp automatisch gesetzt.' }) %>
          <input type="hidden" id="handoverSignerName" value="<%= safeHandoverSignerName %>">
          <input type="hidden" id="returnSignerName" value="<%= safeReturnSignerName %>">
        </div>
        <div class="col-12">
          <label for="signatureCanvas" class="form-label">Unterschrift</label>
          <div class="border rounded p-2">
            <canvas id="signatureCanvas" width="600" height="200" class="w-100" aria-label="Signaturfeld"></canvas>
          </div>
          <div class="d-flex flex-wrap gap-2 mt-2">
            <button id="signatureClear" type="button" class="btn btn-outline-secondary btn-sm">Leeren</button>
            <button id="signatureSave" type="button" class="btn btn-outline-primary btn-sm">Signatur uebernehmen</button>
          </div>
          <% if (typeof errors !== 'undefined' && errors && errors.signatureBase64) { %>
            <div class="text-danger small mt-2" role="alert"><%= errors.signatureBase64 %></div>
          <% } %>
        </div>
      </div>
    </div>
    <div class="card-footer d-flex justify-content-end gap-2">
      <button type="submit" class="btn btn-primary">Speichern</button>
    </div>
  </form>
</section>
<script src="/js/signature.js"></script>
