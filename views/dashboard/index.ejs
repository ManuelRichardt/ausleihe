<% pageTitle = 'Dashboard' %>
<%
  const safeActiveLoans = Array.isArray(activeLoans) ? activeLoans : [];
  const safeReservations = Array.isArray(reservations) ? reservations : [];
  const safeLocationOpenReservations = Array.isArray(locationOpenReservations) ? locationOpenReservations : [];
  const safeLocationTodayHandovers = Array.isArray(locationTodayHandovers) ? locationTodayHandovers : [];
  const safeLocationTodayReturns = Array.isArray(locationTodayReturns) ? locationTodayReturns : [];
  const safeLocationOverdueLoans = Array.isArray(locationOverdueLoans) ? locationOverdueLoans : [];
  const safeFormatDateTime = (typeof formatDateTime === 'function') ? formatDateTime : function () { return '-'; };
  const isLoanManager = Boolean(canManageLoans);
  const hasLocationContext = typeof hasActiveLendingLocation === 'boolean' ? hasActiveLendingLocation : true;
  const toUserLabel = function (loan) {
    if (!loan || !loan.user) {
      return '-';
    }
    const fullName = [loan.user.firstName, loan.user.lastName].filter(Boolean).join(' ');
    return fullName || loan.user.username || loan.user.email || '-';
  };
  const toItemCount = function (loan) {
    return Array.isArray(loan && loan.loanItems) ? loan.loanItems.length : 0;
  };
  const loanStatusBadgeClass = function (status) {
    if (status === 'reserved') return 'text-bg-primary';
    if (status === 'handed_over') return 'text-bg-success';
    if (status === 'overdue') return 'text-bg-danger';
    if (status === 'returned') return 'text-bg-secondary';
    if (status === 'cancelled') return 'text-bg-dark';
    return 'text-bg-light';
  };
%>

<section class="dashboard">
  <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="h3 mb-1">Dashboard</h1>
      <p class="text-muted mb-0">Übersicht über Reservierungen und Ausleihen.</p>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-primary" href="/assets"><i class="bi bi-search me-1"></i>Assets</a>
      <a class="btn btn-outline-secondary" href="/cart"><i class="bi bi-cart3 me-1"></i>Warenkorb</a>
    </div>
  </div>

  <% if (isLoanManager) { %>
    <div class="card shadow-sm mb-4">
      <div class="card-header">
        <h2 class="h5 mb-0">Ausleihe-Übersicht</h2>
      </div>
      <div class="card-body">
        <% if (!hasLocationContext) { %>
          <div class="alert alert-warning mb-0">
            Bitte zuerst eine Ausleihe in der Navigation auswählen, damit die Admin-Übersicht geladen werden kann.
          </div>
        <% } else { %>
          <div class="row g-3 mb-3">
            <div class="col-12 col-md-6 col-xl-3">
              <div class="card h-100 border-primary-subtle">
                <div class="card-body">
                  <div class="text-muted small mb-1">Offene Reservierungen</div>
                  <div class="d-flex align-items-end justify-content-between">
                    <div class="display-6 fw-semibold"><%= safeLocationOpenReservations.length %></div>
                    <a class="btn btn-sm btn-outline-primary" href="/admin/reservations">Anzeigen</a>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12 col-md-6 col-xl-3">
              <div class="card h-100 border-warning-subtle">
                <div class="card-body">
                  <div class="text-muted small mb-1">Heute anstehende Ausleihen</div>
                  <div class="d-flex align-items-end justify-content-between">
                    <div class="display-6 fw-semibold"><%= safeLocationTodayHandovers.length %></div>
                    <a class="btn btn-sm btn-outline-warning" href="/admin/reservations">Anzeigen</a>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12 col-md-6 col-xl-3">
              <div class="card h-100 border-info-subtle">
                <div class="card-body">
                  <div class="text-muted small mb-1">Heute fällige Rückgaben</div>
                  <div class="d-flex align-items-end justify-content-between">
                    <div class="display-6 fw-semibold"><%= safeLocationTodayReturns.length %></div>
                    <a class="btn btn-sm btn-outline-info" href="/admin/loans">Anzeigen</a>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12 col-md-6 col-xl-3">
              <div class="card h-100 border-danger-subtle">
                <div class="card-body">
                  <div class="text-muted small mb-1">Überfällige Ausleihen</div>
                  <div class="d-flex align-items-end justify-content-between">
                    <div class="display-6 fw-semibold"><%= safeLocationOverdueLoans.length %></div>
                    <a class="btn btn-sm btn-outline-danger" href="/admin/loans?status=overdue">Anzeigen</a>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-12">
              <div class="card h-100">
                <div class="card-header">
                  <h3 class="h6 mb-0">Heute anstehende Ausleihen</h3>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                      <thead>
                        <tr>
                          <th>Nutzer</th>
                          <th>Von</th>
                          <th>Items</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody>
                        <% if (safeLocationTodayHandovers.length) { %>
                          <% safeLocationTodayHandovers.slice(0, 8).forEach(function(loan) { %>
                            <tr>
                              <td><%= toUserLabel(loan) %></td>
                              <td><%= safeFormatDateTime(loan.reservedFrom) %></td>
                              <td><%= toItemCount(loan) %></td>
                              <td class="text-end">
                                <a class="btn btn-sm btn-outline-primary" href="/admin/reservations/<%= loan.id %>">Details</a>
                              </td>
                            </tr>
                          <% }) %>
                        <% } else { %>
                          <tr>
                            <td colspan="4" class="text-center text-muted py-3">Keine anstehenden Ausleihen für heute.</td>
                          </tr>
                        <% } %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12">
              <div class="card h-100">
                <div class="card-header">
                  <h3 class="h6 mb-0">Heute fällige Rückgaben</h3>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                      <thead>
                        <tr>
                          <th>Nutzer</th>
                          <th>Bis</th>
                          <th>Items</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody>
                        <% if (safeLocationTodayReturns.length) { %>
                          <% safeLocationTodayReturns.slice(0, 8).forEach(function(loan) { %>
                            <tr>
                              <td><%= toUserLabel(loan) %></td>
                              <td><%= safeFormatDateTime(loan.reservedUntil) %></td>
                              <td><%= toItemCount(loan) %></td>
                              <td class="text-end">
                                <a class="btn btn-sm btn-outline-info" href="/admin/loans/<%= loan.id %>">Details</a>
                              </td>
                            </tr>
                          <% }) %>
                        <% } else { %>
                          <tr>
                            <td colspan="4" class="text-center text-muted py-3">Keine fälligen Rückgaben für heute.</td>
                          </tr>
                        <% } %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12">
              <div class="card h-100">
                <div class="card-header">
                  <h3 class="h6 mb-0">Überfällig</h3>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                      <thead>
                        <tr>
                          <th>Nutzer</th>
                          <th>Bis</th>
                          <th>Items</th>
                          <th></th>
                        </tr>
                      </thead>
                      <tbody>
                        <% if (safeLocationOverdueLoans.length) { %>
                          <% safeLocationOverdueLoans.slice(0, 8).forEach(function(loan) { %>
                            <tr>
                              <td><%= toUserLabel(loan) %></td>
                              <td><%= safeFormatDateTime(loan.reservedUntil) %></td>
                              <td><%= toItemCount(loan) %></td>
                              <td class="text-end">
                                <a class="btn btn-sm btn-outline-danger" href="/admin/loans/<%= loan.id %>">Details</a>
                              </td>
                            </tr>
                          <% }) %>
                        <% } else { %>
                          <tr>
                            <td colspan="4" class="text-center text-muted py-3">Keine überfälligen Ausleihen.</td>
                          </tr>
                        <% } %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% } %>
      </div>
    </div>
  <% } %>

  <div class="card shadow-sm mb-4">
    <div class="card-header">
      <h2 class="h5 mb-0">Meine Reservierungen</h2>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Ausleihe</th>
              <th>Items</th>
              <th>Von</th>
              <th>Bis</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% if (safeReservations.length) { %>
              <% safeReservations.forEach(function(loan) { %>
                <tr>
                  <td><%= loan.lendingLocation ? loan.lendingLocation.name : '-' %></td>
                  <td><%= toItemCount(loan) %></td>
                  <td><%= safeFormatDateTime(loan.reservedFrom) %></td>
                  <td><%= safeFormatDateTime(loan.reservedUntil) %></td>
                  <td><span class="badge <%= loanStatusBadgeClass(loan.status) %>"><%= loan.status %></span></td>
                  <td class="text-end"><a class="btn btn-sm btn-outline-primary" href="/reservations/<%= loan.id %>">Details</a></td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr>
                <td colspan="6" class="text-center text-muted py-3">Keine offenen Reservierungen.</td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header">
      <h2 class="h5 mb-0">Meine Ausleihen</h2>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Ausleihe</th>
              <th>Items</th>
              <th>Von</th>
              <th>Bis</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% if (safeActiveLoans.length) { %>
              <% safeActiveLoans.forEach(function(loan) { %>
                <tr>
                  <td><%= loan.lendingLocation ? loan.lendingLocation.name : '-' %></td>
                  <td><%= toItemCount(loan) %></td>
                  <td><%= safeFormatDateTime(loan.reservedFrom) %></td>
                  <td><%= safeFormatDateTime(loan.reservedUntil) %></td>
                  <td><span class="badge <%= loanStatusBadgeClass(loan.status) %>"><%= loan.status %></span></td>
                  <td class="text-end"><a class="btn btn-sm btn-outline-primary" href="/loans/<%= loan.id %>">Details</a></td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr>
                <td colspan="6" class="text-center text-muted py-3">Keine aktiven Ausleihen.</td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>
