<% pageTitle = 'Mail-System' %>
<%
  const mailConfig = (typeof config !== 'undefined' && config) ? config : {};
  const templatesList = Array.isArray(templates) ? templates : [];
  const notificationList = Array.isArray(notifications) ? notifications : [];
  const currentPage = (pagination && pagination.page) ? pagination.page : 1;
%>

<section class="system mail">
  <div class="d-flex flex-column flex-lg-row align-items-lg-end justify-content-between gap-3 mb-4">
    <div>
      <h1 class="h3 mb-2">Mail-System</h1>
      <p class="text-muted mb-0">Konfiguration, Templates und Benachrichtigungen.</p>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header"><h2 class="h6 mb-0">Konfiguration</h2></div>
        <div class="card-body">
          <form method="post" action="/system/mail/config" class="row g-3">
            <input type="hidden" name="csrfToken" value="<%= csrfToken || '' %>">
            <div class="col-12">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="isEnabled" name="isEnabled" <%= mailConfig.isEnabled ? 'checked' : '' %>>
                <label class="form-check-label" for="isEnabled">Mailversand aktiv</label>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="fromEmail">Absender E-Mail</label>
              <input type="email" class="form-control" id="fromEmail" name="fromEmail" value="<%= mailConfig.fromEmail || '' %>">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="fromName">Absender Name</label>
              <input type="text" class="form-control" id="fromName" name="fromName" value="<%= mailConfig.fromName || '' %>">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="replyTo">Reply-To</label>
              <input type="email" class="form-control" id="replyTo" name="replyTo" value="<%= mailConfig.replyTo || '' %>">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="smtpHost">SMTP Host</label>
              <input type="text" class="form-control" id="smtpHost" name="smtpHost" value="<%= mailConfig.smtpHost || '' %>" placeholder="smtp.example.com">
            </div>
            <div class="col-md-4">
              <label class="form-label" for="smtpPort">SMTP Port</label>
              <input type="number" min="1" max="65535" class="form-control" id="smtpPort" name="smtpPort" value="<%= mailConfig.smtpPort || 587 %>">
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" id="smtpSecure" name="smtpSecure" <%= mailConfig.smtpSecure ? 'checked' : '' %>>
                <label class="form-check-label" for="smtpSecure">SSL/TLS (secure)</label>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="smtpUser">SMTP Benutzer</label>
              <input type="text" class="form-control" id="smtpUser" name="smtpUser" value="<%= mailConfig.smtpUser || '' %>">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="smtpPass">SMTP Passwort</label>
              <input type="password" class="form-control" id="smtpPass" name="smtpPass" value="" autocomplete="new-password" placeholder="Leer lassen, um unverändert zu lassen">
            </div>
            <div class="col-12 d-flex gap-2">
              <button type="submit" class="btn btn-primary">Konfiguration speichern</button>
              <button type="submit" formaction="/system/mail/process-pending" class="btn btn-outline-secondary">Ausstehende senden</button>
              <button type="submit" formaction="/system/mail/queue-reminders" class="btn btn-outline-secondary">Reminder erstellen</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header"><h2 class="h6 mb-0">Testmail</h2></div>
        <div class="card-body">
          <form method="post" action="/system/mail/test" class="row g-3">
            <input type="hidden" name="csrfToken" value="<%= csrfToken || '' %>">
            <div class="col-12">
              <label class="form-label" for="testEmail">Empfänger</label>
              <input type="email" class="form-control" id="testEmail" name="email" required>
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-outline-primary">Testmail senden</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h2 class="h6 mb-0">Templates</h2>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>Key</th>
            <th>Betreff (DE)</th>
            <th>Status</th>
            <th class="actions-col">Aktionen</th>
          </tr>
        </thead>
        <tbody>
          <% if (templatesList.length) { %>
            <% templatesList.forEach(function(template) { %>
              <tr>
                <td><code><%= template.key %></code></td>
                <td><%= template.subjectDe %></td>
                <td>
                  <% if (template.isActive) { %>
                    <span class="badge text-bg-success">Aktiv</span>
                  <% } else { %>
                    <span class="badge text-bg-secondary">Inaktiv</span>
                  <% } %>
                </td>
                <td class="actions-cell">
                  <a href="/system/mail/templates/<%= template.id %>/edit" class="text-decoration-none" aria-label="Template bearbeiten">
                    <i class="bi bi-pencil-fill"></i>
                  </a>
                </td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr>
              <td colspan="4" class="text-muted text-center py-4">Keine Templates vorhanden.</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card shadow-sm mt-4">
    <div class="card-header">
      <h2 class="h6 mb-0">Benachrichtigungen (Seite <%= currentPage %>)</h2>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>Zeitpunkt</th>
            <th>E-Mail</th>
            <th>Template</th>
            <th>Status</th>
            <th>Fehler</th>
          </tr>
        </thead>
        <tbody>
          <% if (notificationList.length) { %>
            <% notificationList.forEach(function(item) { %>
              <tr>
                <td><%= item.createdAt ? item.createdAt.toISOString().slice(0, 19).replace('T', ' ') : '-' %></td>
                <td><%= item.email %></td>
                <td><code><%= item.templateKey %></code></td>
                <td>
                  <% if (item.status === 'sent') { %>
                    <span class="badge text-bg-success">Gesendet</span>
                  <% } else if (item.status === 'failed') { %>
                    <span class="badge text-bg-danger">Fehlgeschlagen</span>
                  <% } else { %>
                    <span class="badge text-bg-warning">Ausstehend</span>
                  <% } %>
                </td>
                <td><%= item.errorMessage || '-' %></td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr>
              <td colspan="5" class="text-muted text-center py-4">Keine Benachrichtigungen vorhanden.</td>
            </tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</section>
