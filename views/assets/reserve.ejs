<% pageTitle = 'Asset reservieren' %>
<%
  const model = assetModel || {};
  const trackingTypeValue = (typeof trackingType !== 'undefined' && trackingType) ? trackingType : (model.trackingType || 'serialized');
  const isBundle = trackingTypeValue === 'bundle';
  const isBulk = trackingTypeValue === 'bulk';
  const safeBundleDefinition = (typeof bundleDefinition !== 'undefined' && bundleDefinition) ? bundleDefinition : null;
  const bundleItems = safeBundleDefinition && Array.isArray(safeBundleDefinition.items) ? safeBundleDefinition.items : [];
  const safeStock = (typeof stock !== 'undefined' && stock) ? stock : null;
  const manufacturer = model.manufacturer || null;
  const safeCsrf = (typeof csrfToken !== 'undefined' && csrfToken) ? csrfToken : '';
  const availability = Array.isArray(dailyAvailability) ? dailyAvailability : [];
%>
<section class="asset-reserve">
  <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="h3 mb-1">Reservierung anlegen</h1>
      <p class="text-muted mb-0"><%= model.name || 'Asset' %> <%= manufacturer ? `(${manufacturer.name})` : '' %></p>
    </div>
    <a class="btn btn-outline-secondary" href="/assets/<%= model.id %>">Zurueck</a>
  </div>

  <div class="row g-4">
    <div class="col-12 col-lg-8">
      <form method="post" action="/cart/items" class="card shadow-sm">
        <input type="hidden" name="csrfToken" value="<%= safeCsrf %>">
        <input type="hidden" name="kind" value="<%= trackingTypeValue %>">
        <input type="hidden" name="assetModelId" value="<%= model.id %>">
        <% if (isBundle && safeBundleDefinition) { %>
          <input type="hidden" name="bundleDefinitionId" value="<%= safeBundleDefinition.id %>">
          <input type="hidden" name="lendingLocationId" value="<%= model.lendingLocation ? model.lendingLocation.id : '' %>">
        <% } %>
        <% if (isBulk) { %>
          <input type="hidden" name="lendingLocationId" value="<%= model.lendingLocation ? model.lendingLocation.id : '' %>">
        <% } %>
        <input type="hidden" id="reservedFrom" name="reservedFrom" value="<%= formData && formData.reservedFrom ? formData.reservedFrom : '' %>">
        <input type="hidden" id="reservedUntil" name="reservedUntil" value="<%= formData && formData.reservedUntil ? formData.reservedUntil : '' %>">

        <div class="card-body">
          <% if (isBundle && !safeBundleDefinition) { %>
            <div class="alert alert-warning">Für dieses Bundle sind noch keine Komponenten konfiguriert.</div>
          <% } %>
          <% if (errors && Object.keys(errors).length) { %>
            <div class="alert alert-danger mb-3">
              <%= Object.values(errors)[0] %>
            </div>
          <% } %>
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label for="quantity" class="form-label">Menge</label>
              <input
                type="number"
                id="quantity"
                name="quantity"
                class="form-control"
                min="1"
                value="<%= (formData && formData.quantity) ? formData.quantity : '1' %>"
                <%= isBundle ? 'readonly' : '' %>
                <%= isBulk && safeStock ? `max=\"${safeStock.quantityAvailable}\"` : '' %>
              >
              <% if (isBundle) { %>
                <div class="form-text">Bundles werden aktuell mit Menge 1 reserviert.</div>
              <% } %>
              <% if (isBulk) { %>
                <div class="form-text">Verfügbar: <%= safeStock ? safeStock.quantityAvailable : 0 %>/<%= safeStock ? safeStock.quantityTotal : 0 %></div>
              <% } %>
            </div>
            <div class="col-md-4">
              <label class="form-label">Von</label>
              <div class="form-control bg-light" id="selectedFrom">-</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Bis</label>
              <div class="form-control bg-light" id="selectedUntil">-</div>
            </div>
          </div>

          <div class="mt-4" data-reservation-calendar>
            <div class="d-flex align-items-center justify-content-between mb-2">
              <button type="button" class="btn btn-outline-secondary btn-sm" data-calendar-prev>
                <i class="bi bi-chevron-left"></i>
              </button>
              <div class="fw-semibold" data-calendar-month> </div>
              <button type="button" class="btn btn-outline-secondary btn-sm" data-calendar-next>
                <i class="bi bi-chevron-right"></i>
              </button>
            </div>
            <div class="table-responsive">
              <table class="table table-bordered align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="text-center">Mo</th>
                    <th class="text-center">Di</th>
                    <th class="text-center">Mi</th>
                    <th class="text-center">Do</th>
                    <th class="text-center">Fr</th>
                    <th class="text-center">Sa</th>
                    <th class="text-center">So</th>
                  </tr>
                </thead>
                <tbody data-calendar-grid></tbody>
              </table>
            </div>
            <div class="small text-muted mt-2">Anklickbar sind nur Tage, an denen die Ausleihe geoeffnet ist und verfuegbare Geraete existieren.</div>
            <div class="form-check form-switch mt-3">
              <input class="form-check-input" type="checkbox" id="toggleAvailability" checked>
              <label class="form-check-label" for="toggleAvailability">Verfuegbare Menge anzeigen</label>
            </div>
          </div>

          <% if (isBundle) { %>
            <div class="mt-4">
              <h2 class="h6 mb-2">Bundle-Komponenten</h2>
              <% if (bundleItems.length) { %>
                <div class="table-responsive">
                  <table class="table table-sm table-hover align-middle mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Komponente</th>
                        <th>Typ</th>
                        <th>Menge</th>
                        <th>Pflicht</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% bundleItems.forEach(function(item) { %>
                        <tr>
                          <td><%= item.componentModel ? item.componentModel.name : '-' %></td>
                          <td><%= item.componentModel ? (item.componentModel.trackingType || 'serialized') : '-' %></td>
                          <td><%= item.quantity || 1 %></td>
                          <td><%= item.isOptional ? 'Optional' : 'Pflicht' %></td>
                        </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
              <% } else { %>
                <p class="text-muted mb-0">Keine Komponenten hinterlegt.</p>
              <% } %>
            </div>
          <% } %>
        </div>

        <div class="card-footer d-flex flex-wrap gap-2 justify-content-end">
          <button type="submit" class="btn btn-primary" <%= (isBundle && !safeBundleDefinition) ? 'disabled' : '' %>>In den Warenkorb</button>
          <a class="btn btn-outline-secondary" href="/assets/<%= model.id %>">Abbrechen</a>
        </div>
      </form>
    </div>

    <div class="col-12 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h2 class="h6 mb-0">Hinweise</h2>
        </div>
        <div class="card-body">
          <p class="text-muted mb-2">Reservierungen muessen innerhalb der Oeffnungszeiten liegen.</p>
          <p class="text-muted mb-0">Beim Abholen wird ein konkretes Asset zugewiesen.</p>
        </div>
      </div>
    </div>
  </div>
</section>

<script type="application/json" id="availability-data"><%- JSON.stringify(availability) %></script>
<script src="/js/reservation-calendar.js"></script>
