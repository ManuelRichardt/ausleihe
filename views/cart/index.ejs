<% pageTitle = 'Warenkorb' %>
<% const safeCsrf = (typeof csrfToken !== 'undefined' && csrfToken) ? csrfToken : ''; %>
<section class="cart">
  <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
    <div>
      <h1 class="h3 mb-1">Warenkorb</h1>
      <p class="text-muted mb-0">Reservierungen sammeln und gesamt absenden.</p>
    </div>
    <a class="btn btn-outline-secondary" href="/assets">Weiter shoppen</a>
  </div>

  <% if (Array.isArray(cartItems) && cartItems.length) { %>
    <div class="card shadow-sm">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Modell</th>
              <th>Hersteller</th>
              <th>Menge</th>
              <th>Von</th>
              <th>Bis</th>
              <th>Ausleihe</th>
              <th class="text-end">Aktionen</th>
            </tr>
          </thead>
          <tbody>
            <% cartItems.forEach(function(item) { %>
              <tr>
                <td><%= item.model ? item.model.name : '-' %></td>
                <td><%= item.model && item.model.manufacturer ? item.model.manufacturer.name : '-' %></td>
                <td>
                  <form method="post" action="/cart/items/<%= item.id %>" class="d-flex gap-2">
                    <input type="hidden" name="csrfToken" value="<%= safeCsrf %>">
                    <input type="hidden" name="reservedFrom" value="<%= item.reservedFrom %>">
                    <input type="hidden" name="reservedUntil" value="<%= item.reservedUntil %>">
                    <input type="number" name="quantity" class="form-control form-control-sm w-auto" min="1" value="<%= item.quantity %>">
                    <button type="submit" class="btn btn-outline-primary btn-sm">Aktualisieren</button>
                  </form>
                </td>
                <td><%= item.reservedFrom %></td>
                <td><%= item.reservedUntil %></td>
                <td><%= item.model && item.model.lendingLocation ? item.model.lendingLocation.name : '-' %></td>
                <td class="text-end">
                  <form method="post" action="/cart/items/<%= item.id %>/delete" class="d-inline">
                    <input type="hidden" name="csrfToken" value="<%= safeCsrf %>">
                    <button type="submit" class="btn btn-outline-danger btn-sm">Entfernen</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>

    <form method="post" action="/cart/checkout" class="d-flex justify-content-end mt-3">
      <input type="hidden" name="csrfToken" value="<%= safeCsrf %>">
      <button type="submit" class="btn btn-primary">Reservierung absenden</button>
    </form>
  <% } else { %>
    <div class="alert alert-light border">Dein Warenkorb ist leer.</div>
  <% } %>
</section>
